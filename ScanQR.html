<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kasir Scan QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      padding: 16px;
    }

    .box {
      max-width: 420px;
      margin: auto;
      background: #fff;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,.15);
    }

    h2 {
      text-align: center;
      margin-top: 0;
    }

    button {
      width: 100%;
      padding: 14px;
      background: #e91e63;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      margin-top: 12px;
      cursor: pointer;
    }

    #result {
      margin-top: 16px;
      font-size: 14px;
    }

    .header-logo {
      text-align: center;
      margin-bottom: 12px;
    }

    .header-logo img {
      max-width: 300px;
      width: 100%;
      height: auto;
    }

    .popup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .popup-box {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      max-width: 320px;
      text-align: center;
    }

    .popup-box button {
      width: 48%;
    }

    .status {
      font-size: 18px;
      font-weight: bold;
      margin-top: 8px;
      padding: 10px;
      border-radius: 8px;
    }

    .status.ok {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status.info {
      background: #e3f2fd;
      color: #1565c0;
    }

    .status.no {
      background: #ffebee;
      color: #c62828;
    }

    .status.warn {
      background: #fff8e1;
      color: #f57f17;
    }

    .status.center {
      text-align: center;
    }

    .quota {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      background: #fff3e0;
      color: #e65100;
      text-align: center;
    }

    .big-btn {
      font-size: 18px;
      padding: 16px;
      margin-top: 14px;
      border-radius: 10px;
    }
  </style>
</head>

<body>

<div class="box">

  <div class="header-logo">
    <img src="Logo Ramadhan Sale.png" alt="Header Event">
  </div>

  <h2>üì∑ Scan QR Customer</h2>

  <div id="reader"></div>
  <div id="result"></div>

</div>

<div class="popup" id="popup">
  <div class="popup-box">
    <p id="popupText"></p>
    <button onclick="beriFreebies()">YA</button>
    <button onclick="tolakFreebies()">TIDAK</button>
  </div>
</div>

<script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz7h4whxWE8a0x2URR0Vrz0INO3Sh_CAc7sDTkhts4ur4qff3qx_oMh7WwSh0qegww/exec";

  let lastData = {};
  let sudahScan = false;

  const qr = new Html5Qrcode("reader");

  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 220 },
    text => {
      if (sudahScan) return;
      sudahScan = true;

      qr.stop();

      const parts = text.trim().split(/\s+/);
      const wa = parts.pop();
      const nama = parts.join(" ");

      prosesScan(nama, wa);
    }
  );

  function prosesScan(nama, wa) {
    const fd = new FormData();
    fd.append("nama", nama);
    fd.append("wa", wa);

    fetch(WEBAPP_URL, { method: "POST", body: fd })
      .then(r => r.json())
      .then(res => {
        lastData = res;

        let statusText = "";
        let statusClass = "";

        if (res.status === "BOLEH_DAPAT") {
          statusText = "üéÅ Dapat Freebies";
          statusClass = "ok";
        } else if (res.status === "SUDAH_PERNAH") {
          const waktu = res.lastFreebiesDate
            ? `<br><small>Di Tanggal: ${res.lastFreebiesDate}</small>`
            : "";
          statusText = `‚ÑπÔ∏è Sudah Pernah Dapat Freebies${waktu}`;
          statusClass = "info";
        } else if (res.status === "KUOTA_HABIS") {
          statusText = "‚õî Kuota Freebies Habis";
          statusClass = "warn";
        } else {
          statusText = "‚ùå Tidak Dapat Freebies";
          statusClass = "no";
        }

        document.getElementById("result").innerHTML = `
          <div><b>Nama :</b> ${res.nama}</div>
          <div><b>No. WA :</b> ${res.wa}</div>
          <div><b>Kunjungan ke :</b> ${res.totalKunjungan}</div>

          <hr style="margin:10px 0">

          <div><b>Jumlah Customer Hari Ini :</b> ${res.jumlahCustomerHariIni ?? "-"}</div>

          <div class="status ${statusClass}">
            ${statusText}
          </div>

          <button class="big-btn" onclick="scanUlang()">
            Scan Customer Berikutnya
          </button>
        `;

        if (res.popup === "KONFIRMASI") {
          document.getElementById("popupText").innerText =
            "Customer ini memenuhi syarat mendapatkan freebies?";
          document.getElementById("popup").style.display = "flex";
        }
      });
  }

  function beriFreebies() {
    const fd = new FormData();
    fd.append("nama", lastData.nama);
    fd.append("wa", lastData.wa);

    fetch(WEBAPP_URL + "?action=beriFreebies", {
      method: "POST",
      body: fd
    }).then(() => {
      document.getElementById("popup").style.display = "none";

      const sisa = Math.max(0, 100 - ((lastData.freebiesHariIni || 0) + 1));

      document.getElementById("result").innerHTML = `
        <div><b>Nama :</b> ${lastData.nama}</div>
        <div><b>No. WA :</b> ${lastData.wa}</div>
        <div><b>Kunjungan ke :</b> ${lastData.totalKunjungan}</div>

        <hr style="margin:10px 0">

        <div><b>Jumlah Customer Hari Ini :</b> ${lastData.jumlahCustomerHariIni ?? "-"}</div>

        <div class="status ok center">
          üéÅ FREEBIES DIBERIKAN
        </div>

        <div class="quota">
          üéÅ Sisa freebies hari ini: ${sisa}
        </div>

        <button class="big-btn" onclick="scanUlang()">
          Scan Customer Berikutnya
        </button>
      `;
    });
  }

  function tolakFreebies() {
    document.getElementById("popup").style.display = "none";

    document.getElementById("result").innerHTML = `
      <div><b>Nama :</b> ${lastData.nama}</div>
      <div><b>No. WA :</b> ${lastData.wa}</div>
      <div><b>Kunjungan ke :</b> ${lastData.totalKunjungan}</div>

      <hr style="margin:10px 0">

      <div><b>Jumlah Customer Hari Ini :</b> ${lastData.jumlahCustomerHariIni ?? "-"}</div>

      <div class="status no center">
        ‚ùå FREEBIES TIDAK DIBERIKAN
      </div>

      <button class="big-btn" onclick="scanUlang()">
        Scan Customer Berikutnya
      </button>
    `;
  }

  function scanUlang() {
    location.reload();
  }
</script>

</body>
</html>

